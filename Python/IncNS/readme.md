# CUDA based 2D periodic NS solver
We construct a NS solver in 2D periodic domain and provide a python interface to faciliate to process computation results and couple with other functions.

## Background
The interface is constructed based on the Qsolver library, which is designed to solve the Landau-Edward energy equation used to depict the behavior of active matter. The solver is accelerated by the CUFFT library provided by nvidia. 

As the file IO and string resolve is quite complex in cpp, so our principle is to assign such mission to python part.

### governing equation
The equation we solved is the voricity form of NS equation:

$\frac{\partial\omega}{\partial t} + \textbf{u}\cdot\nabla\omega = \frac{1}{Re}\Delta\omega$

$\omega = \nabla\times\textbf{u}$

where $\omega$ denotes the vorticity, $\textbf{u} = (u,v)$ denotes the flow field. $Re$ denotes Reynolds number. For the mesh, $N_x$ and $N_y$ grid points are uniformly distributed on $x$ and $y$ axis respectively. The side length of each side is $L_x$ and $L_y$.


## Requisite
1. Python: 

|dependency | version|
|---|---|
|Python| 3.10.10 |
|conda | 23.3.1 |
|torch | 2.1.1 + cu121 |
|pybind11 | 2.11.1 |
|ninja | 1.11.1.1 |

The project is originally constructed under conda environment. requirements.txt record the environment arguments and dependencies.

2. CUDA:

|dependency | version|
|---|---|
|Linux| 4.18.0-305.25.1.el8_4.x86_64 |
|Nvidia Driver| 535.104.05 |
|nvcc| V12.0.140 |
|gcc| 8.4.1 |

## Install
1. After coloning the project, the file structure should be as follow:
```
.
├── include
│   ├── Qsolver.cuh
│   └── timestep.h
├── init
│   └── w_init.csv
├── kernel
│   ├── timestep.cpp
│   └── timestep_kernel.cu
├── makefile
├── readme.md
├── requiements.txt
├── test
    ├── convert.py
    ├── step2.py
    ├── visual.m
    ├── convert.py
    ├── x.csv
    └── y.csv
└── setup.py
```
run following command to construct the library ```Incstep```:
```(shell)
make reset
```
after successful construction, the file structure would be as follow:
```
.
├── Incstep.egg-info
│   ├── PKG-INFO
│   ├── SOURCES.txt
│   ├── dependency_links.txt
│   └── top_level.txt
├── build
│   ├── bdist.linux-x86_64
│   ├── lib.linux-x86_64-cpython-310
│   │   └── Incstep.cpython-310-x86_64-linux-gnu.so
│   └── temp.linux-x86_64-cpython-310
│       ├── build.ninja
│       └── kernel
│           ├── timestep.o
│           └── timestep_kernel.o
├── include
│   ├── Qsolver.cuh
│   └── timestep.h
├── init
│   └── w_init.csv
├── kernel
│   ├── timestep.cpp
│   └── timestep_kernel.cu
├── makefile
├── readme.md
├── requiements.txt
├── setup.py
└── test
    ├── convert.py
    ├── step2.py
    ├── visual.m
    ├── convert.py
    ├── x.csv
    └── y.csv
```


## Usage
### 1 path setting and import 
After construction, each time we want to call the Incstep library, we need to run the following command to add the import path:
```(shell)
make install
```
if you don't have root privilege, please run
```
make user_install
```
We need to import the compiled lib before we call the solver as below:
```(python)
import torch
import Incstep
```
the Incstep lib is the lib we construct before. It should be noted that the order of import. We should ```import torch``` first then ```import Incstep```.

### 2 data structure
We regard ```torch.tensor``` as the basic data structure to manipulate. User only need to master the use of tensor. 

We use a matrix to record $N_x\times N_y$ 2D field data storing in contiguous vector. For more detail, please refer to ```test/step2.py```. matlab script ```visual.m``` provide a function to visualize the field. Noted that the coordinate file ```x.csv``` and ```y.csv``` would be generated by solver though we provide two example. 
### 3 functions and class
There are 2 classes and 2 functions in Incstep lib.

#### Incparam
```Type: class```

This class is used to record the geometric and dynamic parameters.

#### IncSolver
```Type: class```

This class provide a interface to call the CUDA NS solver.

#### VelConvert
```Type: function```
This function is used to convert the vorticity field $\omega$ to velocity fields $u$, $v$.

#### VortConvert
```Type: function```
This function is used to convert the velocity fields $u$, $v$ to vorticity field $\omega$.

For more detail, please refer to the comment in test files.

## Test
```test/step2``` and ```test/convert``` provide the usage example of time stepping and vorticity-velocity conversion respectively. A Taylor green vortex initial conditon is strored in the ```test/init/w_init.csv```. 